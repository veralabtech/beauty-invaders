<!doctype html>
<html lang="it">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Beauty Invaders — spara ai trucchi!</title>
  <style>
    :root {
      --bg: #0f1724;
      --panel: #0b1220aa;
      --accent: #ff7aa2;
      --text: #a2a2a2;
      --pause: #a7a7a7;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100vh;
      /* Support for safe areas on mobile devices */
      height: 100dvh;
      /* Dynamic viewport height for mobile */
      padding-bottom: env(safe-area-inset-bottom);
      box-sizing: border-box;
      font-family: system-ui, -apple-system, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    @media(max-width:880px) {
      body {
        padding: 0;
      }
    }

    .wrap {
      width: 100%;
      height: 100%;
      max-width: 900px;
      max-height: 900px;
      /* Limit height on large screens */
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(0, 0, 0, 0.15));
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6);
      padding: 12px;
      display: flex;
      flex-direction: row;
      gap: 12px;
      box-sizing: border-box;
    }

    @media(max-width:880px) {
      .wrap {
        flex-direction: column;
        max-width: 100%;
        max-height: 100%;
        border-radius: 0;
      }
    }

    .game-area {
      flex: 1;
      min-width: 0;
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    @media(max-width:880px) {
      .game-area {
        min-height: 80vh;
        /* Increase height on mobile for better gameplay */
      }
    }

    canvas {
      background: transparent;
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 8px;
      object-fit: contain;
    }

    /* Welcome Screen */
    .welcome-screen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      text-align: center;
      opacity: 1;
      transition: opacity 0.3s ease;
      pointer-events: auto;
    }

    .welcome-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .welcome-screen.game-over-mode {
      top: 65%;
      /* Position lower on game over to be below the text */
    }

    .game-title {
      font-size: 48px;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 32px;
      text-shadow: 0 4px 12px rgba(255, 122, 162, 0.5);
    }

    .game-title.hidden {
      display: none;
    }

    .button-container {
      display: flex;
      gap: 16px;
      justify-content: center;
      align-items: center;
    }

    .button-container button {
      font-size: 18px;
      padding: 16px 32px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .panel {
      width: 260px;
      flex-shrink: 0;
      padding: 12px;
      background: var(--panel);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
      overflow-y: auto;
    }

    @media(max-width:880px) {
      .panel {
        width: auto;
        max-height: 5%;
        min-height: 150px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .panel h2 {
      margin: 0;
      font-size: 18px;
      color: var(--accent);
      flex: 1;
    }

    #pauseBtn {
      font-size: 14px;
      padding: 8px 14px;
      flex-shrink: 0;
      background-color: var(--pause);
    }

    #pauseBtn.hidden {
      display: none;
    }

    /* Tooltip styling */
    .tooltip {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(11, 18, 32, 0.95);
      border: 2px solid var(--accent);
      border-radius: 12px;
      padding: 20px 24px;
      min-width: 300px;
      z-index: 100;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .tooltip.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .tooltip-content {
      color: var(--text);
      font-size: 15px;
      line-height: 1.6;
      text-align: center;
    }

    .tooltip-close {
      margin-top: 16px;
      width: 100%;
      background: var(--accent);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }

    .tooltip-close:hover {
      opacity: 0.9;
    }

    .stats {
      position: absolute;
      top: 2px;
      right: 50%;
      transform: translateX(50%);
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .stat {
      background: rgba(255, 255, 255, 0.03);
      padding: 8px;
      border-radius: 8px;
      font-size: 14px;
      white-space: nowrap;
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    button {
      background: linear-gradient(180deg, var(--accent), #ff5f8e);
      border: none;
      color: white;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      /* Prevent text selection and Safari touch behaviors on all buttons */
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    button.secondary {
      background: transparent;
      border: 1px solid #ff7aa2;
    }

    .hint {
      font-size: 13px;
      color: #cbd5e1
    }

    .touch-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      gap: 8px;
      justify-content: center;
      padding: 12px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      background: rgba(0, 0, 0, 0.8);
      /* Key: account for safe area in the calculation */
      height: max-content;
      z-index: 100;
    }

    .touch-controls button {
      flex: 1;
      padding: 8px;
      /* Prevent text selection and Safari touch behaviors */
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Larger touch targets */
    @media(max-width:880px) {
      .touch-controls {
        order: -1;
        margin-top: 0 !important;
        margin-bottom: 10px;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="game-area">
      <div class="stats">
        <div class="stat">Punteggio: <span id="score">0</span></div>
        <div class="stat">Vite: <span id="lives">3</span></div>
        <div class="stat">Livello: <span id="level">1</span></div>
        <button id="pauseBtn" class="secondary hidden">Pausa</button>
      </div>
      <div id="helpTooltip" class="tooltip">
        <div class="tooltip-content">
          <p style="text-align: center; font-weight: bold;">Comandi</p>
          <p>Mobile: usa i <b>tasti touch</b> ◀ ▶ per muoverti e <b>Fire</b> per sparare.</p>
          <p>Desktop: muoviti con le <b>frecce</b> della tastiera e premi <b>Space</b> per sparare.</p>
          <p> <strong>Obiettivo:</strong>
            elimina i prodotti prima che arrivino alla base, ma <strong>fai attenzione all'alieno</strong>, colpirlo ti
            farà perdere vite!
          </p>
          <button id="closeTooltipBtn" class="tooltip-close">Chiudi</button>
        </div>
      </div>
      <canvas id="game"></canvas>
      <div id="welcomeScreen" class="welcome-screen">
        <h1 id="gameTitle" class="game-title">Beauty Invaders</h1>
        <div class="button-container">
          <button id="startBtn">Avvia</button>
          <button id="helpBtn" class="secondary">Aiuto</button>
        </div>
      </div>
    </div>
    <aside class="panel" style="margin-bottom: 16px;">
      <div class="touch-controls" style="margin-top:auto;">
        <button id="leftTouch">◀</button>
        <button id="shootTouch">FIRE</button>
        <button id="rightTouch">▶</button>
      </div>

    </aside>
  </div>

  <script>
    /* -----------------------
       Beauty Invaders (single file)
       - Canvas game with falling "trucchi" (emoji)
       - Move left/right, shoot with space
       - Touch support for mobile
       ----------------------- */

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d', { alpha: true });
    let W, H, scale;
    function resize() {
      // handle HiDPI
      const rect = canvas.getBoundingClientRect();
      W = Math.max(420, rect.width);
      H = Math.max(500, rect.height);
      scale = window.devicePixelRatio || 1;
      canvas.width = Math.floor(W * scale);
      canvas.height = Math.floor(H * scale);
      // canvas.style.width/height are handled by CSS now
      ctx.setTransform(scale, 0, 0, scale, 0, 0);
    }
    window.addEventListener('resize', resize);
    resize();

    /* Game state */
    let runLoop = null;
    let lastTime = 0;
    let game = {
      score: 0,
      lives: 3,
      level: 1,
      running: false,
      paused: false,
      spawnTimer: 0,
      spawnInterval: 1200, // ms
      difficultyTimer: 0
    };

    /* Player */
    const player = {
      w: 86,
      h: 86,
      x: 0,
      y: 0,
      speed: 420, // px/s
      color: '#ffdbe6',
      bullets: [],
      shootCooldown: 0,
      shootDelay: 300,
      img: new Image()
    };
    player.img.onload = () => draw();
    player.img.src = 'public/invaders/alien/alien-05.png';

    /* Falling items (trucchi) */
    const items = [];
    /* Falling items (trucchi) */
    const productTypes = [
      { src: 'public/invaders/products/product-01.png', score: 40, img: new Image() },
      { src: 'public/invaders/products/product-02.png', score: 30, img: new Image() },
      { src: 'public/invaders/products/product-03.png', score: 20, img: new Image() },
      { src: 'public/invaders/alien/alien-07.png', score: -15, img: new Image() }
    ];
    // Preload images
    productTypes.forEach(p => {
      if (p.src) {
        p.img.src = p.src;
      }
    });

    /* Helpers */
    function rand(min, max) { return Math.random() * (max - min) + min; }
    function spawnItem() {
      // Count current aliens on screen
      const currentAliens = items.filter(item => item.score < 0).length;

      let pick;
      // Check if we can spawn an alien (less than 2 on screen)
      if (currentAliens < 2) {
        // Dynamic spawn rate: 20% base + 10% per level, capped at 70%
        const alienSpawnRate = Math.min(0.70, 0.20 + (game.level - 1) * 0.10);
        const shouldSpawnAlien = Math.random() < alienSpawnRate;
        if (shouldSpawnAlien) {
          pick = productTypes[3]; // alien-07 is at index 3
        } else {
          // Spawn a random product instead
          const productOnlyTypes = productTypes.slice(0, 3); // products only
          pick = productOnlyTypes[Math.floor(Math.random() * productOnlyTypes.length)];
        }
      } else {
        const productOnlyTypes = productTypes.slice(0, 3); // products only
        pick = productOnlyTypes[Math.floor(Math.random() * productOnlyTypes.length)];
      }

      const size = rand(70, 80); // slightly larger for images
      const item = {
        x: rand(20, W - 60),
        y: -50,
        size: size,
        score: pick.score,
        vy: rand(70, 150) + (game.level - 1) * 15,
        vx: rand(-20, 20),
        type: pick.type || 'product',
        img: pick.img
      };
      items.push(item);
    }

    /* Input */
    const keys = {};
    window.addEventListener('keydown', e => {
      keys[e.key] = true;
      if (e.key === ' ') { e.preventDefault(); }
    });
    window.addEventListener('keyup', e => {
      keys[e.key] = false;
    });
    /* Touch controls */
    document.getElementById('leftTouch').addEventListener('touchstart', e => { e.preventDefault(); keys['ArrowLeft'] = true; });
    document.getElementById('leftTouch').addEventListener('touchend', e => { e.preventDefault(); keys['ArrowLeft'] = false; });
    document.getElementById('leftTouch').addEventListener('mousedown', e => { e.preventDefault(); keys['ArrowLeft'] = true; });
    document.getElementById('leftTouch').addEventListener('mouseup', e => { e.preventDefault(); keys['ArrowLeft'] = false; });
    document.getElementById('rightTouch').addEventListener('touchstart', e => { e.preventDefault(); keys['ArrowRight'] = true; });
    document.getElementById('rightTouch').addEventListener('touchend', e => { e.preventDefault(); keys['ArrowRight'] = false; });
    document.getElementById('rightTouch').addEventListener('mousedown', e => { e.preventDefault(); keys['ArrowRight'] = true; });
    document.getElementById('rightTouch').addEventListener('mouseup', e => { e.preventDefault(); keys['ArrowRight'] = false; });
    document.getElementById('shootTouch').addEventListener('click', e => { keys[' '] = true; setTimeout(() => keys[' '] = false, 80); });

    /* UI */
    const scoreEl = document.getElementById('score');
    const livesEl = document.getElementById('lives');
    const levelEl = document.getElementById('level');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const helpBtn = document.getElementById('helpBtn');
    const helpTooltip = document.getElementById('helpTooltip');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const gameTitle = document.getElementById('gameTitle');

    let tooltipTimeout = null;

    startBtn.addEventListener('click', startGame);
    pauseBtn.addEventListener('click', togglePause);

    // Help button functionality
    helpBtn.addEventListener('click', () => {
      helpTooltip.classList.add('visible');

      // Clear any existing timeout
      if (tooltipTimeout) clearTimeout(tooltipTimeout);

      // Auto-close after 8 seconds
      tooltipTimeout = setTimeout(() => {
        helpTooltip.classList.remove('visible');
      }, 12000);
    });

    // Close button functionality
    const closeTooltipBtn = document.getElementById('closeTooltipBtn');
    closeTooltipBtn.addEventListener('click', () => {
      helpTooltip.classList.remove('visible');
      if (tooltipTimeout) clearTimeout(tooltipTimeout);
    });

    function startGame() {
      // reset
      game.score = 0; game.lives = 3; game.level = 1;
      game.spawnInterval = 1200; game.spawnTimer = 0; game.difficultyTimer = 0;
      items.length = 0; player.bullets.length = 0;
      player.shootCooldown = 0;
      game.running = true; game.paused = false;

      // Hide welcome screen and show pause button
      welcomeScreen.classList.add('hidden');
      welcomeScreen.classList.remove('game-over-mode'); // Remove game over positioning
      pauseBtn.classList.remove('hidden');
      helpTooltip.classList.remove('visible');
      if (tooltipTimeout) clearTimeout(tooltipTimeout);

      // Reset button text and title visibility for next time
      startBtn.textContent = 'Avvia';
      gameTitle.classList.remove('hidden');

      lastTime = performance.now();
      positionPlayer();
      loop(lastTime);
    }
    function togglePause() {
      if (!game.running) return;
      game.paused = !game.paused;
      if (!game.paused) { lastTime = performance.now(); loop(lastTime); }
    }

    /* Place player */
    function positionPlayer() {
      player.x = (W - player.w) / 2;
      player.y = H - player.h - 18;
    }

    /* Shooting */
    function shoot() {
      const now = performance.now();
      if (player.shootCooldown > now) return;
      player.shootCooldown = now + player.shootDelay;
      const b = {
        x: player.x + player.w / 2 - 4,
        y: player.y - 10,
        w: 6, h: 12, vy: -560
      };
      player.bullets.push(b);
    }

    /* Collisions (AABB) */
    function hit(a, b) {
      return !(a.x + a.w < b.x || a.x > b.x + b.w || a.y + a.h < b.y || a.y > b.y + b.h);
    }

    /* Main loop */
    function loop(t) {
      if (!game.running || game.paused) return;
      const dt = Math.min(40, t - lastTime); // ms
      const s = dt / 1000;
      lastTime = t;

      // update difficulty
      game.difficultyTimer += dt;
      if (game.difficultyTimer > 8000) {
        game.difficultyTimer = 0;
        game.level++;
        game.spawnInterval = Math.max(420, game.spawnInterval - 100);
      }

      // spawn items
      game.spawnTimer += dt;
      if (game.spawnTimer >= game.spawnInterval) {
        game.spawnTimer = 0;
        // spawn 1 or sometimes 2
        spawnItem();
        if (Math.random() < Math.min(0.25, game.level * 0.03)) spawnItem();
      }

      // player movement
      if (keys['ArrowLeft'] || keys['a']) player.x -= player.speed * s;
      if (keys['ArrowRight'] || keys['d']) player.x += player.speed * s;
      // bounds
      if (player.x < 6) player.x = 6;
      if (player.x + player.w > W - 6) player.x = W - 6 - player.w;

      // shooting
      if ((keys[' '] || keys['Spacebar'])) shoot();

      // update bullets
      for (let i = player.bullets.length - 1; i >= 0; i--) {
        const b = player.bullets[i];
        b.y += b.vy * s;
        if (b.y + b.h < -10) player.bullets.splice(i, 1);
      }

      // update items
      for (let i = items.length - 1; i >= 0; i--) {
        const it = items[i];
        it.x += it.vx * s;
        it.y += it.vy * s;
        // bounce a bit horizontally
        if (it.x < 6 || it.x + it.size > W - 6) it.vx *= -1;

        // check if reached bottom
        if (it.y > H - 20) {
          // Products (score > 0) cause you to lose a life
          if (it.score > 0) {
            game.lives -= 1;
            if (game.lives <= 0) { gameOver(); return; }
          }
          // Remove the item (whether product or alien)
          items.splice(i, 1);
        } else {
          // check collision with bullets
          for (let j = player.bullets.length - 1; j >= 0; j--) {
            const b = player.bullets[j];
            const bb = { x: b.x, y: b.y, w: b.w, h: b.h };
            const ib = { x: it.x, y: it.y, w: it.size, h: it.size };
            if (hit(bb, ib)) {
              // hit!
              player.bullets.splice(j, 1);

              // Check if this is the alien (negative score)
              if (it.score < 0) {
                // Shooting the alien causes you to lose a life!
                game.lives -= 1;
                items.splice(i, 1);
                if (game.lives <= 0) { gameOver(); return; }
              } else {
                // Normal product - add score
                game.score += it.score;
                // small chance to add extra life for high score hits
                if (Math.random() < 0.03) game.lives = Math.min(5, game.lives + 1);
                items.splice(i, 1);
              }
              break;
            }
          }
        }
      }

      // UI update
      scoreEl.textContent = game.score;
      livesEl.textContent = game.lives;
      levelEl.textContent = game.level;

      // render
      draw();

      runLoop = requestAnimationFrame(loop);
    }

    /* Draw frame */
    function draw() {
      // clear
      ctx.clearRect(0, 0, W, H);
      // background vignette
      const g = ctx.createLinearGradient(0, 0, 0, H);
      g.addColorStop(0, 'rgba(255,255,255,0.02)');
      g.addColorStop(1, 'rgba(0,0,0,0.06)');
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, W, H);

      // draw items
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      for (const it of items) {
        if (it.type === 'bomb') {
          ctx.fillStyle = '#ffffff';
          ctx.font = `${Math.floor(it.size)}px system-ui, sans-serif`;
          ctx.shadowColor = 'rgba(0,0,0,0.45)';
          ctx.shadowBlur = 6;
          ctx.fillText(it.emoji, it.x + it.size / 2, it.y + it.size / 2);
          ctx.shadowBlur = 0;
        } else {
          // Draw product image directly
          if (it.img && it.img.complete) {
            ctx.drawImage(it.img, it.x, it.y, it.size, it.size);
          } else {
            // Fallback
            ctx.fillStyle = '#fff';
            ctx.fillRect(it.x, it.y, it.size, it.size);
          }
        }
      }

      // draw player (alien svg)
      if (player.img.complete) {
        ctx.drawImage(player.img, player.x, player.y, player.w, player.h);
      }

      // bullets
      ctx.fillStyle = '#fff0';
      for (const b of player.bullets) {
        ctx.fillStyle = '#ffe6f1';
        roundRect(ctx, b.x, b.y, b.w, b.h, 3, true, false);
      }

      // HUD (top)
      ctx.fillStyle = 'rgba(255,255,255,0.02)';
      ctx.fillRect(6, 6, W - 12, 36);
    }

    /* Game over */
    function gameOver() {
      game.running = false;
      cancelAnimationFrame(runLoop);

      // Show welcome screen without title, change button text
      welcomeScreen.classList.remove('hidden');
      welcomeScreen.classList.add('game-over-mode'); // Position lower on game over
      gameTitle.classList.add('hidden'); // Hide title on game over
      startBtn.textContent = 'Riavvia';
      pauseBtn.classList.add('hidden');

      // draw final overlay
      ctx.fillStyle = 'rgba(2,6,23,0.7)';
      ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = 'white';
      ctx.textAlign = 'center';
      ctx.font = '32px system-ui, serif';
      ctx.fillText('Game Over', W / 2, H / 2 - 24);
      ctx.font = '20px system-ui, serif';
      ctx.fillText(`Punteggio: ${game.score}`, W / 2, H / 2 + 8);
      ctx.font = '14px system-ui, serif';
      ctx.fillText('Premi RIAVVIA per giocare di nuovo', W / 2, H / 2 + 40);
    }

    /* Utility: rounded rect */
    function roundRect(ctx, x, y, w, h, r, fill, stroke) {
      if (typeof stroke === 'undefined') { stroke = true; }
      if (typeof r === 'undefined') { r = 5; }
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.arcTo(x + w, y, x + w, y + h, r);
      ctx.arcTo(x + w, y + h, x, y + h, r);
      ctx.arcTo(x, y + h, x, y, r);
      ctx.arcTo(x, y, x + w, y, r);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }

    /* initial */
    positionPlayer();
    draw();

    /* small keyboard pause binding */
    window.addEventListener('keydown', e => {
      if (e.key === 'p') togglePause();
      if (e.key === 'r') startGame();
    });

    /* auto start? no - wait for user */
  </script>
</body>

</html>